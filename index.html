<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BOOKCLEAR - 선택형 관광 코스</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;margin:0;background:#f6f7fb;color:#111;}
    .wrap{max-width:760px;margin:0 auto;padding:20px;}
    .card{background:rgba(255,255,255,0.92);backdrop-filter: blur(2px);border-radius:16px;padding:18px;box-shadow:0 8px 22px rgba(0,0,0,.10);margin:14px 0;}
    h1{font-size:20px;margin:0 0 6px;}
    .muted{color:#666;font-size:14px;line-height:1.4}
    .text{font-size:16px;line-height:1.6;margin:12px 0 8px;}
    button{width:100%;text-align:left;border:1px solid #e6e7ef;background:#fff;border-radius:12px;padding:12px 12px;margin:8px 0;font-size:15px;cursor:pointer;}
    button:hover{background:#fafbff}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#eef2ff;border-radius:999px;padding:6px 10px;font-size:13px;color:#3647d6}
    .footer{font-size:12px;color:#777;margin-top:16px}
    .small{font-size:13px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}

    /* 배경 레이어(사진 기반 2D 느낌) */
    #bg{
      position: fixed;
      inset: 0;
      background-size: cover;
      background-position: center;
      z-index: -1;
      filter: brightness(0.80) saturate(1.12) contrast(1.06) blur(0.3px);
      transform: scale(1.06);
      transition: opacity .35s ease;
      opacity: 1;
    }
    .bg-motion{
      animation: slowPan 18s ease-in-out infinite alternate;
    }
    @keyframes slowPan{
      from { transform: scale(1.06) translateY(0px); }
      to   { transform: scale(1.10) translateY(-8px); }
    }

    /* 텍스트/버튼 애니메이션 */
    .fade-text { animation: fadeInUp 0.7s ease forwards; opacity: 0; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .choice-btn { animation: popIn 0.25s ease forwards; transform: scale(0.98); }
    @keyframes popIn { to { transform: scale(1); } }
  </style>
</head>
<body>
  <div id="bg"></div>

  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1 id="title">BOOKCLEAR</h1>
          <div class="muted" id="subtitle">QR로 시작하는 선택형 관광 코스</div>
        </div>
        <div class="pill" id="themePill">테마: -</div>
      </div>

      <div class="text" id="text">로딩 중…</div>
      <div id="choices"></div>

      <div class="row">
        <button class="small" id="backBtn" style="width:auto">← 뒤로</button>
        <button class="small" id="restartBtn" style="width:auto">⟲ 처음으로</button>
      </div>

      <div class="footer">
        *배경 이미지가 없으면 기본 배경(default.jpg)으로 표시됩니다. images/ 폴더에 파일을 올리고 routes.json의 bg를 맞춰주세요.
      </div>
    </div>
  </div>

<script>
async function main(){
  const res = await fetch('./routes.json');
  const ROUTES = await res.json();

  const params = new URLSearchParams(location.search);
  const themeKey = params.get('theme') || Object.keys(ROUTES)[0];
  const theme = ROUTES[themeKey] || ROUTES[Object.keys(ROUTES)[0]];
  const themeName = theme.title || themeKey;

  const titleEl = document.getElementById('title');
  const pillEl = document.getElementById('themePill');
  const textEl = document.getElementById('text');
  const choicesEl = document.getElementById('choices');
  const backBtn = document.getElementById('backBtn');
  const restartBtn = document.getElementById('restartBtn');
  const bgEl = document.getElementById('bg');

  titleEl.textContent = 'BOOKCLEAR';
  pillEl.textContent = '테마: ' + themeName;

  const history = [];
  let currentId = theme.start;

  function escapeHtml(str){
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  function applyBg(node){
    const bgUrl = (node && node.bg) ? node.bg : 'images/default.jpg';
    bgEl.style.opacity = 0;
    setTimeout(() => {
      bgEl.style.backgroundImage = `url(${bgUrl})`;
      bgEl.classList.add('bg-motion');
      bgEl.style.opacity = 1;
    }, 150);
  }

  function render(){
    const node = theme.nodes[currentId];
    choicesEl.innerHTML = '';

    if(!node){
      textEl.textContent = '해당 루트를 찾을 수 없어요. routes.json을 확인하세요.';
      return;
    }

    applyBg(node);
    textEl.innerHTML = `<div class="fade-text">${escapeHtml(node.text || '')}</div>`;

    if(node.ending){
      const b = document.createElement('button');
      b.classList.add('choice-btn');
      b.textContent = '도서관으로 돌아가 엔딩북 확인하기';
      b.onclick = () => alert('완주 인증은 도서관 스탬프/스티커로 진행하세요!');
      choicesEl.appendChild(b);
      return;
    }

    (node.choices || []).forEach(ch=>{
      const btn = document.createElement('button');
      btn.classList.add('choice-btn');
      btn.textContent = ch.label;
      btn.onclick = () => {
        history.push(currentId);
        currentId = ch.next;
        render();
      };
      choicesEl.appendChild(btn);
    });
  }

  backBtn.onclick = () => {
    if(history.length === 0) return;
    currentId = history.pop();
    render();
  };

  restartBtn.onclick = () => {
    history.length = 0;
    currentId = theme.start;
    render();
  };

  render();
}
main();
</script>
</body>
</html>
